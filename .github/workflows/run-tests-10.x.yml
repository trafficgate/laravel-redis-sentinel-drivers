name: run-tests

on: [push, pull_request]

jobs:
    tests:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                php: [8.1, 8.2]
                dependency-version: [prefer-lowest, prefer-stable]
                framework: [laravel, lumen]
                laravel-version: ["10.*"]
                horizon: [0, 1]
                include:

                exclude:
                  # lumen doesn't support horizon
                  - framework: lumen
                    horizon: 0

        name: P${{ matrix.php }} - ${{ matrix.dependency-version }}

        steps:
            -   name: Checkout code
                uses: actions/checkout@v2

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php }}
                    extensions: zip
                    coverage: none

            -   name: Setup dependencies
                run: |
                    if [ "${{ matrix.framework }}" == "laravel" ]; then
                        composer remove --dev --no-update "laravel/lumen-framework"
                        composer require --dev --no-update "laravel/laravel-framework:${{ matrix.laravel-version }}"
                    else if [ "${{ matrix.framework }}" == "lumen" ]; then
                        composer remove --dev --no-update "laravel/laravel-framework"
                        composer require --dev --no-update "laravel/lumen-framework:${{ matrix.laravel-version }}"
                    fi

                    if [ "${{ matrix.horizon }}" == "0" ]; then
                        composer remove --dev --no-update "laravel/horizon"
                    fi

            -   name: Install dependencies
                run: composer update --${{ matrix.dependency-version }} --prefer-dist --no-interaction

            -   name: Start up cluster
                run: ./start-cluster.sh || { cat /.cluser/*.log; false; }

            -   name: Setup Problem Matches
                run: |
                    echo "::add-matcher::${{ runner.tool_cache }}/php.json"
                    echo "::add-matcher::${{ runner.tool_cache }}/phpunit.json"

            -   name: Execute tests
                run: |
                    EXCLUDE_GROUPS="+laravel-only,-horizon"

                    if [ "${{ matrix.framework }}" == "lumen" ]; then
                        EXCLUDE_GROUPS="-horizon"
                    fi

                    if [ "${{ matrix.horizon }}" == "1" ]; then
                        EXCLUDE_GROUPS=""
                    fi

                    vendor/bin/phpunit --exclude-group ${EXCLUDE_GROUPS}
